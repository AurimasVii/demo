<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Žaidimo informacija</title>
  <style>
    /* --- Copied from App.css for footer, side menu, and icons --- */
    body {
      background: #f9fbfd;
      font-family: 'Inter', 'Segoe UI', 'Roboto', Arial, sans-serif;
      color: #23272f;
      margin: 0;
      padding: 0;
    }
    .Footer {
      background: #fff;
      text-align: center;
      padding: 2vw 0 1vw 0;
      border-top: 1px solid #eaeaea;
      font-size: 1em;
      color: #888;
      margin-top: 3vw;
    }
    .FooterLinks {
      display: flex;
      justify-content: center;
      gap: 2vw;
      margin-bottom: 0.5em;
    }
    .FooterLinks a {
      color: #888;
      text-decoration: none;
      transition: color 0.18s;
      font-size: 1em;
      padding: 0.2em 0.6em;
      border-radius: 6px;
    }
    .FooterLinks a:hover {
      color: #0077ff;
      background: #f0f7ff;
    }
    .SocialIcon {
      width: 2.2em;
      height: 2.2em;
      min-width: 32px;
      min-height: 32px;
      max-width: 40px;
      max-height: 40px;
      object-fit: contain;
      filter: grayscale(0.2) brightness(0.97);
      transition: filter 0.18s, transform 0.18s;
      cursor: pointer;
      border-radius: 50%;
      background: #f5f7fa;
      padding: 0.2em;
      display: inline-block;
    }
    .SocialIcon:hover {
      filter: none;
      transform: scale(1.12);
      background: #e0e7ef;
    }
    .SideMenuDrawer {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 270px;
      background: #fff;
      box-shadow: 2px 0 16px rgba(0,0,0,0.08);
      z-index: 1200;
      transform: translateX(-110%);
      transition: transform 0.25s;
      display: flex;
      flex-direction: column;
      padding: 2em 1.2em 1em 1.2em;
    }
    .SideMenuDrawer.open {
      transform: translateX(0);
    }
    .SideMenuOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(30,40,60,0.10);
      z-index: 1199;
    }
    @media (max-width: 600px) {
      .Footer {
        font-size: 0.98em;
        padding: 2vw 0 2vw 0;
      }
      .FooterLinks {
        gap: 4vw;
      }
      .SideMenuDrawer {
        width: 90vw;
        min-width: 0;
        padding: 2em 1em 1em 1em;
      }
    }
    body {
      font-family: 'Inter', 'Segoe UI', 'Roboto', Arial, sans-serif;
      background: #f9fbfd;
      color: #23272f;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 420px;
      margin: 3vw auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 2px 18px rgba(0,0,0,0.04);
      padding: 2vw 5vw 2vw 5vw;
      text-align: center;
    }
    h1 {
      color: #0077ff;
      font-size: 2em;
      margin-bottom: 0.2em;
    }
    .category {
      color: #888;
      font-size: 1em;
      margin-bottom: 1em;
    }
    .slider {
      position: relative;
      width: 100%;
      max-width: 320px;
      margin: 0 auto 1.5em auto;
      overflow: hidden;
      border-radius: 12px;
      background: #f8fafc;
      box-shadow: 0 2px 8px rgba(0,119,255,0.04);
    }
    .slider img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 12px;
      display: block;
    }
    .slider-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,119,255,0.7);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      font-size: 1.5em;
      cursor: pointer;
      z-index: 2;
      transition: background 0.18s;
    }
    .slider-btn:hover {
      background: #005fcc;
    }
    .slider-btn.left { left: 8px; }
    .slider-btn.right { right: 8px; }
    .price {
      color: #0077ff;
      font-weight: 600;
      margin-bottom: 0.7em;
      font-size: 1.1em;
    }
    .desc {
      color: #444;
      margin-bottom: 0.7em;
    }
    .info {
      color: #555;
      font-size: 0.98em;
      margin-bottom: 1.2em;
    }
    #reservationInfo {
      margin-top: 1.5em;
      padding: 1em;
      background: #f0f7ff;
      border-radius: 10px;
      color: #23272f;
      font-size: 1em;
      text-align: left;
    }
    #reserveBtn {
      background: #0077ff;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.7em 2em;
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      margin: 1em 0 0 0;
    }
    @media (max-width: 600px) {
      .container {
        max-width: 98vw;
        padding: 4vw 2vw;
      }
      .slider img {
        height: 120px;
      }
    }
  </style>
</head>
<body>
  <button id="menuBtn" aria-label="Atidaryti meniu" style="position:fixed;top:20px;left:20px;z-index:1100;background:#0077ff;color:#fff;border:none;border-radius:50%;width:44px;height:44px;font-size:1.7em;cursor:pointer;box-shadow:0 2px 8px rgba(0,119,255,0.10);">&#9776;</button>
  <div id="sideMenuOverlay" class="SideMenuOverlay" style="display:none;"></div>
  <div id="sideMenuDrawer" class="SideMenuDrawer" style="display:none;">
    <button id="closeMenuBtn" style="position:absolute;top:18px;right:18px;background:none;border:none;font-size:2em;color:#bbb;cursor:pointer;">&times;</button>
    <div style="display:flex;align-items:center;gap:1em;margin-bottom:1.5em;">
      <img src="/logo192.png" alt="Logo" style="width:44px;height:44px;border-radius:12px;" />
      <span style="font-weight:600;font-size:1.2em;color:#0077ff;">Įmonės Pavadinimas</span>
    </div>
    <nav style="display:flex;flex-direction:column;gap:0.7em;margin-bottom:2em;">
      <a href="/" id="mainPageLink" style="text-decoration:none;color:#23272f;font-weight:500;">Pagrindinis</a>
      <a href="#apie" style="text-decoration:none;color:#23272f;font-weight:500;">Apie mus</a>
      <a href="#paslaugos" style="text-decoration:none;color:#23272f;font-weight:500;">Paslaugos</a>
      <a href="#uzsakymai" style="text-decoration:none;color:#23272f;font-weight:500;">Užsakymai</a>
    </nav>
    <div style="display:flex;gap:0.7em;margin-bottom:2em;">
      <a href="https://instagram.com/aurimasvi" target="_blank" rel="noopener"><img src="/icons/instagram.png" alt="Instagram" class="SocialIcon" /></a>
      <a href="https://facebook.com/aurimas.vizinis" target="_blank" rel="noopener"><img src="/icons/facebook.png" alt="Facebook" class="SocialIcon" /></a>
      <a href="https://mail.google.com/mail/?view=cm&to=aurimav05@gmail.com" target="_blank" rel="noopener"><img src="/icons/mail.png" alt="Gmail" class="SocialIcon" /></a>
    </div>
    <div style="border-top:1px solid #f2f4f8;margin:1em 0;"></div>
    <div style="font-weight:600;margin-bottom:0.7em;color:#23272f;">Kategorijos</div>
    <div id="sideMenuCategories" style="display:flex;flex-direction:column;gap:0.5em;"></div>
  </div>
  <div class="container">
    <h1 id="gameName"></h1>
    <div class="category" id="gameCategory"></div>
    <div class="slider" id="slider" style="position:relative;max-width:420px;margin:0 auto 1em auto;overflow:hidden;">
      <button id="sliderPrev" class="slider-btn left" style="display:none;position:absolute;top:50%;transform:translateY(-50%);z-index:2;">&#8592;</button>
      <img id="sliderImg" src="/icons/confetti.png" alt="Veiklos nuotrauka" style="width:100%;max-height:320px;object-fit:cover;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.07);background:#f7faff;">
      <button id="sliderNext" class="slider-btn right" style="display:none;position:absolute;top:50%;right:0;transform:translateY(-50%);z-index:2;">&#8594;</button>
      <div id="sliderDots" style="text-align:center;margin-top:0.7em;"></div>
    </div>
    <div class="price" id="gamePrice"></div>
    <div class="desc" id="gameDesc"></div>
    <div class="info" id="gameInfo"></div>
    <button id="reserveBtn" style="background:#0077ff;color:#fff;border:none;border-radius:8px;padding:0.7em 2em;font-size:1em;font-weight:500;cursor:pointer;margin:1em 0 0 0;">Rezervuoti</button>
    <div id="reservationInfo" style="margin-top:1.5em;padding:1em;background:#f0f7ff;border-radius:10px;color:#23272f;font-size:1em;text-align:left;"></div>
  </div>
  <footer class="Footer">
    <div class="FooterLinks">
      <a href="#kontaktai">Kontaktai</a>
      <a href="#privatumas">Privatumo politika</a>
      <a href="#taisykles">Naudojimosi taisyklės</a>
    </div>
    <p>&copy; Įmonės Pavadinimas</p>
  </footer>
  <div id="infoModal" style="display:none;position:fixed;z-index:2000;inset:0;background:rgba(30,40,60,0.18);align-items:center;justify-content:center;">
    <div id="infoContent" style="background:#fff;border-radius:18px;box-shadow:0 8px 32px rgba(0,119,255,0.10);padding:2.5vw 5vw;max-width:95vw;width:350px;position:relative;text-align:center;display:flex;flex-direction:column;align-items:center;">
      <button id="closeInfoModal" style="position:absolute;top:1em;right:1em;background:none;border:none;font-size:2em;color:#bbb;cursor:pointer;">&times;</button>
      <div id="infoBody"></div>
    </div>
  </div>
  <div id="reservationModal" style="display:none;position:fixed;z-index:3000;inset:0;background:rgba(30,40,60,0.18);align-items:center;justify-content:center;">
    <div id="reservationModalContent" style="background:#fff;border-radius:18px;box-shadow:0 8px 32px rgba(0,119,255,0.10);padding:2.5vw 5vw;max-width:95vw;width:350px;position:relative;text-align:center;display:flex;flex-direction:column;align-items:center;">
      <button id="closeReservationModal" style="position:absolute;top:1em;right:1em;background:none;border:none;font-size:2em;color:#bbb;cursor:pointer;">&times;</button>
      <h2 id="reservationModalTitle" style="color:#0077ff;font-weight:700;margin-bottom:0.7em;">Rezervacija</h2>
      <form id="reservationForm" style="width:100%;max-width:320px;display:flex;flex-direction:column;gap:0.7em;">
        <input type="text" name="name" placeholder="Jūsų vardas" required />
        <input type="email" name="email" placeholder="El. paštas" required />
        <input type="tel" name="phone" placeholder="Telefonas" required />
        <label style="margin-top:0.5em;font-weight:500;text-align:left;">Pasirinkite datą ir laiką:</label>
        <input type="date" name="date" required />
        <input type="time" name="time" required />
        <button type="submit" style="background:#0077ff;color:#fff;border:none;border-radius:8px;padding:0.7em 2em;font-size:1em;font-weight:500;cursor:pointer;margin-top:1em;">Rezervuoti</button>
      </form>
      <div id="reservationSuccess" style="display:none;color:#388e3c;font-weight:600;margin-top:1em;"></div>
      <div id="reservationError" style="display:none;color:#d32f2f;font-weight:600;margin-top:1em;"></div>
    </div>
  </div>
  <script>
    // --- Side menu and navigation logic (unchanged) ---
    // ...existing code...

    // --- Fetch activity by id or name from URL param ---
    async function fetchActivity() {
      const params = new URLSearchParams(window.location.search);
      let id = params.get('id');
      let name = params.get('name');
      activities = await fetch('/api/activities').then(r => r.json());
      // Try to get from localStorage if no id or name
      if (!id && !name) {
        const storedId = localStorage.getItem('selectedGameId');
        const storedName = localStorage.getItem('selectedGameName');
        if (storedId) {
          id = storedId;
        }
        if (!id && storedName) {
          name = storedName;
        }
      }
      // Try to find by id (string or number)
      if (id) {
        activity = activities.find(a => String(a._id) === String(id));
      }
      // If not found by id, try by name (case-insensitive)
      if ((!activity || !activity._id) && name) {
        name = decodeURIComponent(name).toLowerCase().trim();
        activity = activities.find(a => a.name && a.name.toLowerCase().trim() === name);
      }
      // If still not found, try by name from id (React may store name in id param)
      if ((!activity || !activity._id) && id) {
        const idAsName = decodeURIComponent(id).toLowerCase().trim();
        activity = activities.find(a => a.name && a.name.toLowerCase().trim() === idAsName);
      }
      // If still not found, try by mainImage (for edge cases)
      if ((!activity || !activity._id) && id) {
        activity = activities.find(a => a.mainImage && a.mainImage.includes(id));
      }
      // Debug logging for all attempts
      if (!activity || !activity._id) {
        document.getElementById('gameName').textContent = 'Veikla nerasta';
        document.getElementById('reserveBtn').style.display = 'none';
        console.warn('Activity not found. Params:', { id, name, activities });
        return;
      }
      // Fill in activity info
      document.getElementById('gameName').textContent = activity.name;
      document.getElementById('gameCategory').textContent = activity.category;
      document.getElementById('gamePrice').textContent = activity.price;
      document.getElementById('gameDesc').textContent = activity.description;
      document.getElementById('gameInfo').textContent = activity.info;
      // Render image slider (show mainImage or first image)
      const slider = document.getElementById('slider');
      slider.innerHTML = '';
      // Prefer images from localStorage if present (from React)
      let images = [];
      try {
        const storedImages = localStorage.getItem('selectedGameImages');
        if (storedImages) images = JSON.parse(storedImages);
      } catch {}
      if (!images || !images.length) {
        images = (activity.images && activity.images.length) ? activity.images : (activity.mainImage ? [activity.mainImage] : []);
      }
      if (images.length > 0) {
        let idx = 0;
        const img = document.createElement('img');
        img.id = 'sliderImg';
        img.src = images[0];
        img.alt = activity.name;
        img.style.maxWidth = '100%';
        img.style.maxHeight = '220px';
        img.style.borderRadius = '12px';
        img.style.objectFit = 'cover';
        img.style.boxShadow = '0 2px 12px rgba(0,119,255,0.07)';
        slider.appendChild(img);
        // If multiple images, add left/right buttons
        if (images.length > 1) {
          const leftBtn = document.createElement('button');
          leftBtn.textContent = '<';
          leftBtn.className = 'slider-btn left';
          leftBtn.onclick = function() {
            idx = (idx - 1 + images.length) % images.length;
            img.src = images[idx];
          };
          slider.appendChild(leftBtn);
          const rightBtn = document.createElement('button');
          rightBtn.textContent = '>';
          rightBtn.className = 'slider-btn right';
          rightBtn.onclick = function() {
            idx = (idx + 1) % images.length;
            img.src = images[idx];
          };
          slider.appendChild(rightBtn);
        }
      }
      // If activity.quantity is 0, show message and disable reservation
      if (activity.hasQuantity && activity.quantity === 0) {
        document.getElementById('reserveBtn').textContent = 'Šiuo metu šios veiklos rezervuoti negalima';
        document.getElementById('reserveBtn').disabled = true;
        document.getElementById('reserveBtn').style.background = '#bbb';
      } else {
        document.getElementById('reserveBtn').textContent = 'Rezervuoti';
        document.getElementById('reserveBtn').disabled = false;
        document.getElementById('reserveBtn').style.background = '';
      }
      // ...existing code...
    }

    // --- Side menu open/close logic ---
    const menuBtn = document.getElementById('menuBtn');
    const sideMenuDrawer = document.getElementById('sideMenuDrawer');
    const sideMenuOverlay = document.getElementById('sideMenuOverlay');
    const closeMenuBtn = document.getElementById('closeMenuBtn');
    menuBtn.addEventListener('click', function() {
      sideMenuDrawer.style.display = 'block';
      setTimeout(() => sideMenuDrawer.classList.add('open'), 10);
      sideMenuOverlay.style.display = 'block';
    });
    closeMenuBtn.addEventListener('click', function() {
      sideMenuDrawer.classList.remove('open');
      setTimeout(() => sideMenuDrawer.style.display = 'none', 250);
      sideMenuOverlay.style.display = 'none';
    });
    sideMenuOverlay.addEventListener('click', function() {
      sideMenuDrawer.classList.remove('open');
      setTimeout(() => sideMenuDrawer.style.display = 'none', 250);
      sideMenuOverlay.style.display = 'none';
    });

    // --- Render categories in side menu ---
    async function renderSideMenuCategories() {
      let cats = [];
      try {
        const stored = localStorage.getItem('categories');
        if (stored) cats = JSON.parse(stored);
      } catch {}
      if (!cats.length) {
        const acts = await fetch('/api/activities').then(r => r.json());
        const uniqueCats = [...new Set(acts.map(a => a.category))];
        cats = uniqueCats.map(catName => ({
          key: catName.replace(/\s/g, '').toLowerCase(),
          name: catName,
          icon: {
            'Vandens pramogos': '/icons/swimming.png',
            'Renginių įrangos nuoma': '/icons/tools.png',
            'Pramogų vedimas': '/icons/confetti.png',
            'Lauko žaidimai': '/icons/park.png',
            'Vidaus pramogos': '/icons/cinema.png',
            'Šaudymo pramogos': '/icons/shooting-range.png'
          }[catName] || '/icons/confetti.png'
        }));
      }
      const container = document.getElementById('sideMenuCategories');
      container.innerHTML = '';
      cats.forEach(cat => {
        const a = document.createElement('a');
        a.href = '/?category=' + encodeURIComponent(cat.name);
        a.style.cssText = 'display:flex;align-items:center;gap:0.7em;text-decoration:none;color:#0077ff;font-weight:500;padding:0.4em 0;border-radius:8px;background:#fff;box-shadow:0 2px 16px rgba(0,0,0,0.04);margin-bottom:0.5em;min-width:110px;min-height:80px;';
        const img = document.createElement('img');
        img.src = cat.icon || '/icons/confetti.png';
        img.alt = cat.name;
        img.style.cssText = 'width:32px;height:32px;border-radius:8px;object-fit:cover;box-shadow:0 2px 8px #eaf3ff;background:#f8fafc;';
        img.onerror = function() { this.onerror = null; this.src = '/icons/confetti.png'; };
        const span = document.createElement('span');
        span.textContent = cat.name;
        span.style.cssText = 'font-size:1.1em;';
        a.appendChild(img);
        a.appendChild(span);
        a.onclick = function(e) {
          e.preventDefault();
          localStorage.setItem('scrollToCategory', cat.key);
          localStorage.setItem('scrollSmooth', '1');
          window.location.href = '/';
        };
        container.appendChild(a);
      });
    }
    renderSideMenuCategories();

    // --- Reservation Modal Logic (unified with React modal) ---
    let activity = null;
    let activities = [];
    let availableTimes = [];
    let selectedDate = '';
    let selectedTime = '';
    let isSubmitting = false;

    // --- Fetch activity by name from URL param ---
    async function fetchActivity() {
      const params = new URLSearchParams(window.location.search);
      let name = params.get('name');
      if (!name) {
        document.getElementById('gameName').textContent = 'Veikla nerasta';
        document.getElementById('reserveBtn').style.display = 'none';
        return;
      }
      name = decodeURIComponent(name).toLowerCase().trim();
      activities = await fetch('/api/activities').then(r => r.json());
      activity = activities.find(a => a.name.toLowerCase().trim() === name);
      if (!activity) {
        document.getElementById('gameName').textContent = 'Veikla nerasta';
        document.getElementById('reserveBtn').style.display = 'none';
        return;
      }
      // Fill in activity info
      document.getElementById('gameName').textContent = activity.name;
      document.getElementById('gameCategory').textContent = activity.category;
      document.getElementById('gamePrice').textContent = activity.price;
      document.getElementById('gameDesc').textContent = activity.description;
      document.getElementById('gameInfo').textContent = activity.info;
      // Render image slider (show mainImage or first image)
      const slider = document.getElementById('slider');
      slider.innerHTML = '';
      let images = (activity.images && activity.images.length) ? activity.images : (activity.mainImage ? [activity.mainImage] : []);
      if (images.length > 0) {
        let idx = 0;
        const img = document.createElement('img');
        img.src = images[0];
        img.alt = activity.name;
        img.style.maxWidth = '100%';
        img.style.maxHeight = '220px';
        img.style.borderRadius = '12px';
        img.style.objectFit = 'cover';
        img.style.boxShadow = '0 2px 12px rgba(0,119,255,0.07)';
        slider.appendChild(img);
        // If multiple images, add simple left/right buttons
        if (images.length > 1) {
          const leftBtn = document.createElement('button');
          leftBtn.textContent = '<';
          leftBtn.className = 'slider-btn left';
          leftBtn.onclick = function() {
            idx = (idx - 1 + images.length) % images.length;
            img.src = images[idx];
          };
          slider.appendChild(leftBtn);
          const rightBtn = document.createElement('button');
          rightBtn.textContent = '>';
          rightBtn.className = 'slider-btn right';
          rightBtn.onclick = function() {
            idx = (idx + 1) % images.length;
            img.src = images[idx];
          };
          slider.appendChild(rightBtn);
        }
      }
    }

    // --- Reservation Modal UI ---
    function showReservationModal() {
      if (!activity) return;
      const modal = document.getElementById('reservationModal');
      modal.style.display = 'flex';
      let disabledMsg = '';
      if (activity.hasQuantity && activity.quantity === 0) {
        disabledMsg = '<div style="color:#d32f2f;margin:1em 0;font-weight:600">Šiuo metu šios veiklos rezervuoti negalima</div>';
      }
      modal.innerHTML = `
        <div class="CheckoutContent" style="max-width:480px;width:95vw;max-height:90vh;overflow-y:auto;padding:2em 1.5em;border-radius:18px;background:#fff;box-shadow:0 4px 32px rgba(0,119,255,0.10);position:relative;display:flex;flex-direction:column;align-items:center;">
          <button class="CloseBtn" aria-label="Uždaryti" style="position:absolute;top:18px;right:18px;font-size:2em;background:none;border:none;color:#bbb;cursor:pointer;" onclick="closeReservationModal()">&times;</button>
          <h2 style="margin-top:0;color:#0077ff;font-size:1.3em;">Rezervuoti: ${activity.name}</h2>
          ${activity.mainImage ? `<img src="${activity.mainImage}" alt="${activity.name}" style="max-width:90%;max-height:180px;border-radius:12px;margin-bottom:1em;object-fit:cover;box-shadow:0 2px 12px rgba(0,119,255,0.07);" />` : ''}
          <form id="reservationForm" class="CheckoutForm" autocomplete="off" style="width:100%;max-width:320px;display:flex;flex-direction:column;gap:0.7em;">
            <input type="text" name="name" placeholder="Jūsų vardas" required ${activity.hasQuantity && activity.quantity === 0 ? 'disabled' : ''} />
            <input type="email" name="email" placeholder="El. paštas" required ${activity.hasQuantity && activity.quantity === 0 ? 'disabled' : ''} />
            <input type="tel" name="phone" placeholder="Telefonas" required ${activity.hasQuantity && activity.quantity === 0 ? 'disabled' : ''} />
            ${activity.hasQuantity && activity.quantity === 0 ? disabledMsg : `
              <input type="date" name="date" required min="${new Date().toISOString().slice(0,10)} " />
              <select name="time" required style="margin-top:0.3em;">
                <option value="">Pasirinkite laiką</option>
              </select>
              <button type="submit" style="background:#0077ff;color:#fff;border:none;border-radius:8px;padding:0.7em 2em;font-size:1em;font-weight:500;margin-top:0.7em;">Rezervuoti</button>
            `}
          </form>
        </div>
      `;
      if (!(activity.hasQuantity && activity.quantity === 0)) {
        document.getElementById('reservationForm').addEventListener('submit', submitReservationForm);
        document.querySelector('#reservationForm input[name="date"]').addEventListener('change', onDateChange);
      }
    }
    function closeReservationModal() {
      document.getElementById('reservationModal').style.display = 'none';
      document.body.style.overflow = '';
    }

    // --- Available times logic (match React modal) ---
    const DEFAULT_TIMES = [
      '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00'
    ];
    async function onDateChange(e) {
      selectedDate = e.target.value;
      if (!selectedDate) return;
      // Fetch reservations for this activity/date
      const res = await fetch(`/api/reservations?activityId=${activity._id}&date=${selectedDate}`);
      const reservations = await res.json();
      // Build available times
      let times = [...DEFAULT_TIMES];
      let disabled = {};
      if (activity.hasQuantity) {
        // Count reservations per time
        for (const t of times) {
          const count = reservations.filter(r => r.time === t).length;
          if (count >= (activity.quantity || 1)) disabled[t] = true;
        }
      } else {
        for (const t of times) {
          if (reservations.some(r => r.time === t)) disabled[t] = true;
        }
      }
      // Render options
      const select = document.querySelector('#reservationForm select[name="time"]');
      select.innerHTML = '<option value="">Pasirinkite laiką</option>' +
        times.map(t => `<option value="${t}" ${disabled[t] ? 'disabled style=\'color:#bbb\'' : ''}>${t}${disabled[t] ? ' (užimta)' : ''}</option>`).join('');
    }

    // --- Reservation form submit ---
    async function submitReservationForm(e) {
      e.preventDefault();
      if (isSubmitting) return;
      isSubmitting = true;
      const form = e.target;
      const data = Object.fromEntries(new FormData(form));
      data.activityId = activity._id;
      // Validate
      if (!data.name || !data.email || !data.phone || !data.date || !data.time) {
        showReservationError('Užpildykite visus laukus.');
        isSubmitting = false;
        return;
      }
      // Email regex (simple)
      if (!/^\S+@\S+\.\S+$/.test(data.email)) {
        showReservationError('Neteisingas el. pašto formatas.');
        isSubmitting = false;
        return;
      }
      // Phone: at least 6 digits
      if (!/\d{6,}/.test(data.phone)) {
        showReservationError('Neteisingas telefono numeris.');
        isSubmitting = false;
        return;
      }
      // POST to backend
      try {
        const resp = await fetch('/api/reservations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!resp.ok) {
          const err = await resp.json();
          showReservationError(err.error || 'Rezervacija nepavyko.');
          isSubmitting = false;
          // After error, re-fetch available times to update UI
          await onDateChange({ target: { value: data.date } });
          return;
        }
        // Success
        document.getElementById('reservationModal').innerHTML = `
          <div class="CheckoutModal" style="background:#fff;border-radius:16px;max-width:420px;width:95vw;padding:2em 1.5em;box-shadow:0 2px 24px rgba(0,119,255,0.10);animation:fadeIn 0.2s;position:relative;display:flex;flex-direction:column;align-items:center;">
            <button class="CloseBtn" aria-label="Uždaryti" style="position:absolute;top:16px;right:16px;font-size:1.7em;background:none;border:none;color:#bbb;cursor:pointer;" onclick="closeReservationModal()">&times;</button>
            <h2 style="color:#00c48c;margin-top:1em;">Rezervacija sėkminga!</h2>
            <p style="font-size:1.1em;margin:1.5em 0 0.5em 0;">Ačiū, jūsų rezervacija priimta.<br>Patvirtinimą gausite el. paštu.</p>
            <button onclick="closeReservationModal()" style="background:#0077ff;color:#fff;border:none;border-radius:8px;padding:0.7em 2em;font-size:1em;font-weight:500;cursor:pointer;margin-top:1.5em;">Uždaryti</button>
          </div>
        `;
        // After success, re-fetch available times for this date (in case user wants to book again)
        await onDateChange({ target: { value: data.date } });
      } catch (e) {
        showReservationError('Rezervacija nepavyko.');
        // After error, re-fetch available times to update UI
        await onDateChange({ target: { value: data.date } });
      }
      isSubmitting = false;
    }
    function showReservationError(msg) {
      document.getElementById('reservationError').textContent = msg;
    }

    // --- Attach reservation modal to button ---
    document.getElementById('reserveBtn').addEventListener('click', showReservationModal);

    // --- On load, fetch activity ---
    window.addEventListener('DOMContentLoaded', fetchActivity);

    // --- Close modal on overlay click ---
    document.getElementById('reservationModal').addEventListener('click', function(e) {
      if (e.target === this) closeReservationModal();
    });
  </script>
</body>
</html>
