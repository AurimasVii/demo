<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Secret</title>
  <style>
    body {
      background: #f9fbfd;
      font-family: 'Inter', 'Segoe UI', 'Roboto', Arial, sans-serif;
      color: #23272f;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .admin-container {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 18px rgba(0,0,0,0.06);
      padding: 2.5vw 5vw;
      max-width: 350px;
      width: 100%;
      text-align: center;
    }
    input[type="password"] {
      padding: 0.7em 1em;
      border-radius: 8px;
      border: 1px solid #e0e7ef;
      font-size: 1em;
      outline: none;
      margin-bottom: 1em;
      width: 90%;
      transition: border 0.18s;
    }
    input[type="password"]:focus {
      border: 1.5px solid #0077ff;
    }
    button {
      background: #0077ff;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.7em 2em;
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.18s, transform 0.18s;
    }
    button:hover {
      background: #005fcc;
      transform: translateY(-2px) scale(1.03);
    }
    .error {
      color: #d32f2f;
      margin-bottom: 1em;
      font-size: 0.98em;
    }
    .secret-content {
      margin-top: 2em;
      color: #0077ff;
      font-size: 1.1em;
      font-weight: 600;
      display: none;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <h2>Admin prisijungimas</h2>
    <div id="error" class="error"></div>
    <input type="password" id="adminPass" placeholder="SlaptaÅ¾odis" />
    <br />
    <button onclick="checkPassword()">Prisijungti</button>
    <button id="goReservationsBtn" style="margin-left:1em;display:none;background:#00c48c;" onclick="window.location.href='/admin-reservations.html'">Rezervacijos</button>
    <div id="secretContent" class="secret-content">
      <p>Slapta administratoriaus informacija! ðŸŽ‰</p>
      <form id="addGameForm" style="margin-top:2em;text-align:left;">
        <input type="hidden" id="editMode" value="" />
        <label>Kategorija:<br>
          <input type="text" id="gameCategory" placeholder="pvz. Vandens pramogos" required style="width:100%;margin-bottom:0.7em;" />
        </label><br>
        <label>Pavadinimas:<br>
          <input type="text" id="gameName" placeholder="Å½aidimo pavadinimas" required style="width:100%;margin-bottom:0.7em;" />
        </label><br>
        <label>ApraÅ¡ymas:<br>
          <textarea id="gameDesc" placeholder="Trumpas apraÅ¡ymas" required style="width:100%;margin-bottom:0.7em;"></textarea>
        </label><br>
        <label>Kaina:<br>
          <input type="text" id="gamePrice" placeholder="pvz. 40â‚¬ / val." required style="width:100%;margin-bottom:0.7em;" />
        </label><br>
        <label>Informacija (kaip vyks, kur rinktis ir pan.):<br>
          <textarea id="gameInfo" placeholder="Papildoma informacija" required style="width:100%;margin-bottom:0.7em;"></textarea>
        </label><br>
        <label>Nuotraukos:<br>
          <input type="file" id="gameImages" accept="image/*" multiple style="margin-bottom:0.7em;" />
          <span style="font-size:0.97em;color:#888;">Galite Ä¯kelti bet kokio dydÅ¾io nuotraukas. Jos bus automatiÅ¡kai pritaikytos rodymui.</span>
        </label><br>
        <button type="submit">IÅ¡saugoti Å¾aidimÄ…</button>
        <button type="button" id="cancelEditBtn" style="display:none;margin-left:1em;">AtÅ¡aukti redagavimÄ…</button>
      </form>
      <div id="gamePreview" style="margin-top:2em;"></div>
      <hr style="margin:2em 0;">
      <h3>Visi Å¾aidimai pagal kategorijas</h3>
      <div id="adminGamesList"></div>
    </div>
  </div>
  <script>
    function checkPassword() {
      var pass = document.getElementById('adminPass').value;
      var error = document.getElementById('error');
      var secret = document.getElementById('secretContent');
      var correct = 'admin123';
      if (pass === correct) {
        error.textContent = '';
        secret.style.display = 'block';
        document.getElementById('adminPass').style.display = 'none';
        event.target.style.display = 'none';
        // Set admin login flag for access to reservations page
        localStorage.setItem('admin_logged_in', '1');
        document.getElementById('goReservationsBtn').style.display = 'inline-block';
        renderAdminGames();
      } else {
        error.textContent = 'Neteisingas slaptaÅ¾odis!';
        secret.style.display = 'none';
      }
    }

    // Helper: get/set categories in localStorage
    function getCategories() {
      const stored = localStorage.getItem('categories');
      if (stored) {
        try { return JSON.parse(stored); } catch { return []; }
      }
      return [];
    }
    function setCategories(cats) {
      localStorage.setItem('categories', JSON.stringify(cats));
    }

    // Render all games by category, with edit/delete and move
    function renderAdminGames() {
      var cats = getCategories();
      var out = '';
      if (!cats.length) {
        out = '<i>NÄ—ra Å¾aidimÅ³.</i>';
      } else {
        cats.forEach(function(cat, ci) {
          out += `<div style="margin-bottom:1.5em;display:flex;align-items:center;gap:0.7em;">
            <b style='color:#0077ff;'>${cat.name}</b>
            <button onclick='deleteCategory(${ci})' style='color:#fff;background:#d32f2f;border:none;border-radius:6px;padding:0.2em 0.8em;font-size:0.98em;cursor:pointer;margin-left:0.7em;'>IÅ¡trinti kategorijÄ…</button>
          </div>`;
          out += '<ul style="padding-left:1em;">';
          (cat.games||[]).forEach(function(game, gi) {
            // Move to other category dropdown
            var moveDropdown = '';
            if (cats.length > 1) {
              moveDropdown = `<select data-move-cat="${ci}" data-move-gi="${gi}" style='margin-left:0.5em;'>` +
                cats.map(function(c, idx) {
                  if (idx === ci) return '';
                  return `<option value='${idx}'>Perkelti Ä¯: ${c.name}</option>`;
                }).join('') +
                `</select>`;
            }
            out += `<li style='margin-bottom:0.5em;'>
              <span style='font-weight:600;'>${game.name}</span> - ${game.price}<br>
              <span style='font-size:0.95em;color:#555;'>${game.description}</span><br>
              <button onclick='editGame(${ci},${gi})'>Redaguoti</button>
              <button onclick='deleteGame(${ci},${gi})' style='margin-left:0.5em;color:#d32f2f;'>IÅ¡trinti</button>
              ${moveDropdown}
            </li>`;
          });
          out += '</ul>';
        });
      }
      document.getElementById('adminGamesList').innerHTML = out;
      // Add event listeners for move dropdowns
      Array.from(document.querySelectorAll('select[data-move-cat]')).forEach(function(sel) {
        sel.onchange = function() {
          var fromCat = parseInt(sel.getAttribute('data-move-cat'));
          var gameIdx = parseInt(sel.getAttribute('data-move-gi'));
          var toCat = parseInt(sel.value);
          moveGame(fromCat, gameIdx, toCat);
        };
      });
    }

    // Delete category function
    function deleteCategory(catIdx) {
      var cats = getCategories();
      if (confirm('Ar tikrai norite iÅ¡trinti Å¡iÄ… kategorijÄ… ir visus jos Å¾aidimus?')) {
        cats.splice(catIdx, 1);
        setCategories(cats);
        renderAdminGames();
      }
    }

    // Move game to another category
    function moveGame(fromCat, gameIdx, toCat) {
      var cats = getCategories();
      if (cats[fromCat] && cats[toCat] && cats[fromCat].games[gameIdx]) {
        var game = cats[fromCat].games.splice(gameIdx, 1)[0];
        cats[toCat].games.push(game);
        setCategories(cats);
        renderAdminGames();
      }
    }

    // Add game logic (with edit support)
    document.addEventListener('DOMContentLoaded', function() {
      var form = document.getElementById('addGameForm');
      if (!form) return;
      var preview = document.getElementById('gamePreview');
      var editModeInput = document.getElementById('editMode');
      var cancelEditBtn = document.getElementById('cancelEditBtn');
      // Store images to be kept/removed during edit
      var currentEditImages = [];
      var mainImageIdx = 0;

      form.onsubmit = function(e) {
        e.preventDefault();
        var category = document.getElementById('gameCategory').value.trim();
        var name = document.getElementById('gameName').value.trim();
        var desc = document.getElementById('gameDesc').value.trim();
        var price = document.getElementById('gamePrice').value.trim();
        var info = document.getElementById('gameInfo').value.trim();
        var imagesInput = document.getElementById('gameImages');
        var files = imagesInput.files;
        var isEdit = editModeInput.value !== '';
        if (!name || !desc || !price || !info || !category) {
          preview.innerHTML = '<span style="color:#d32f2f;">UÅ¾pildykite visus laukus.</span>';
          return;
        }
        if (!files.length && !isEdit && (!currentEditImages || !currentEditImages.length)) {
          preview.innerHTML = '<span style="color:#d32f2f;">PridÄ—kite bent vienÄ… nuotraukÄ….</span>';
          return;
        }
        var cats = getCategories();
        var catIdx = -1;
        for (var j = 0; j < cats.length; j++) {
          if (cats[j].name === category) { catIdx = j; break; }
        }
        var oldImages = [];
        if (isEdit && catIdx !== -1 && cats[catIdx].games[parseInt(editModeInput.value)]) {
          oldImages = currentEditImages.slice(); // Use the filtered images
        }
        var readers = [];
        if (files.length) {
          for (let i = 0; i < files.length; i++) {
            readers.push(new Promise((resolve) => {
              var reader = new FileReader();
              reader.onload = function(ev) { resolve(ev.target.result); };
              reader.readAsDataURL(files[i]);
            }));
          }
          Promise.all(readers).then(function(imgs) {
            function resizeImage(src, maxW, maxH) {
              return new Promise(function(resolve) {
                var img = new window.Image();
                img.onload = function() {
                  var w = img.width, h = img.height;
                  var scale = Math.min(maxW / w, maxH / h, 1);
                  if (scale < 1) { w = w * scale; h = h * scale; }
                  var canvas = document.createElement('canvas');
                  canvas.width = w; canvas.height = h;
                  var ctx = canvas.getContext('2d');
                  ctx.drawImage(img, 0, 0, w, h);
                  resolve(canvas.toDataURL('image/jpeg', 0.92));
                };
                img.onerror = function() { resolve(src); };
                img.src = src;
              });
            }
            var resizeAll = imgs.map(function(img) { return resizeImage(img, 1200, 900); });
            Promise.all(resizeAll).then(function(resizedImgs) {
              var allImages = isEdit ? oldImages.concat(resizedImgs) : resizedImgs;
              finishGameSave(allImages);
            });
          });
        } else {
          finishGameSave(oldImages);
        }
        function finishGameSave(imagesArr) {
          var gameObj = {
            name: name,
            description: desc,
            images: imagesArr,
            price: price,
            info: info,
            mainImage: imagesArr[mainImageIdx] || imagesArr[0] || ''
          };
          if (isEdit) {
            if (catIdx !== -1 && cats[catIdx].games[parseInt(editModeInput.value)]) {
              cats[catIdx].games[parseInt(editModeInput.value)] = gameObj;
              setCategories(cats);
              renderAdminGames();
              preview.innerHTML = '<span style="color:#388e3c;">Å½aidimas atnaujintas!</span>';
              form.reset();
              editModeInput.value = '';
              cancelEditBtn.style.display = 'none';
              currentEditImages = [];
            }
          } else {
            if (catIdx === -1) {
              cats.push({ key: category.toLowerCase().replace(/\s+/g,'-'), name: category, icon: '', games: [gameObj] });
            } else {
              cats[catIdx].games.push(gameObj);
            }
            setCategories(cats);
            renderAdminGames();
            preview.innerHTML = '<span style="color:#388e3c;">Å½aidimas pridÄ—tas!</span>';
            form.reset();
            currentEditImages = [];
          }
        }
      };

      // Helper to render image preview with delete buttons and main image selector
      function renderImagePreview(images, mainIdx) {
        preview.innerHTML = images.map(function(img, idx) {
          return `<div style="display:inline-block;margin-right:0.5em;margin-bottom:0.5em;position:relative;">
            <img src="${img}" style="max-width:100px;max-height:75px;border-radius:8px;${mainIdx===idx?'border:2px solid #0077ff;':''}">
            <button type="button" data-img-idx="${idx}" style="position:absolute;top:2px;right:2px;background:#d32f2f;color:#fff;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer;font-size:15px;line-height:18px;padding:0;">&times;</button>
            <button type="button" data-main-idx="${idx}" style="position:absolute;bottom:2px;left:2px;background:${mainIdx===idx?'#0077ff':'#e0e7ef'};color:#fff;border:none;border-radius:6px;padding:0 6px;font-size:12px;cursor:pointer;">${mainIdx===idx?'PagrindinÄ—':'Padaryti pagrindine'}</button>
          </div>`;
        }).join('');
        // Add event listeners for delete buttons
        Array.from(preview.querySelectorAll('button[data-img-idx]')).forEach(function(btn) {
          btn.onclick = function() {
            var idx = parseInt(btn.getAttribute('data-img-idx'));
            currentEditImages.splice(idx, 1);
            if (mainImageIdx >= currentEditImages.length) mainImageIdx = 0;
            renderImagePreview(currentEditImages, mainImageIdx);
          };
        });
        // Add event listeners for main image buttons
        Array.from(preview.querySelectorAll('button[data-main-idx]')).forEach(function(btn) {
          btn.onclick = function() {
            mainImageIdx = parseInt(btn.getAttribute('data-main-idx'));
            renderImagePreview(currentEditImages, mainImageIdx);
          };
        });
      }

      // Edit game function (override global)
      window.editGame = function(catIdx, gameIdx) {
        var cats = getCategories();
        if (cats[catIdx] && cats[catIdx].games[gameIdx]) {
          var game = cats[catIdx].games[gameIdx];
          document.getElementById('gameCategory').value = cats[catIdx].name;
          document.getElementById('gameName').value = game.name;
          document.getElementById('gameDesc').value = game.description;
          document.getElementById('gamePrice').value = game.price;
          document.getElementById('gameInfo').value = game.info;
          document.getElementById('editMode').value = gameIdx;
          currentEditImages = (game.images||[]).slice();
          mainImageIdx = 0;
          if (game.images && game.mainImage) {
            var idx = game.images.indexOf(game.mainImage);
            if (idx !== -1) mainImageIdx = idx;
          }
          renderImagePreview(currentEditImages, mainImageIdx);
          cancelEditBtn.style.display = 'inline-block';
        }
      };

      // Cancel edit button logic
      cancelEditBtn.onclick = function() {
        form.reset();
        editModeInput.value = '';
        preview.innerHTML = '';
        cancelEditBtn.style.display = 'none';
        currentEditImages = [];
      };
    });

    // Delete game function
    function deleteGame(catIdx, gameIdx) {
      var cats = getCategories();
      if (confirm('Ar tikrai norite iÅ¡trinti Å¡Ä¯ Å¾aidimÄ…?')) {
        if (cats[catIdx] && cats[catIdx].games[gameIdx]) {
          cats[catIdx].games.splice(gameIdx, 1);
          setCategories(cats);
          renderAdminGames();
        }
      }
    }

    // Auto-fill password for demo (remove in production)
    document.getElementById('adminPass').value = 'admin123';
  </script>
</body>
</html>
